---
title: "nsf_snowdepths_datawrangling"
output: html_document
date: "2024-08-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set Up

```{r}
library(tidyverse)
library(lterdatasampler)
library(dplyr)
library(ggplot2)
library(readr)
library(readxl)
library(lubridate)
library(plotly)
library(openxlsx)
library(plotly)
library(rstatix)
library(htmlwidgets)
library(RColorBrewer)
library(patchwork)
library(ggpubr)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

## Calling in Data

### Weather Station Data

```{r}
transb_wx_15min_r <- read_csv('nsf/trans_burned/trans_burned_wx_15min_r.csv') %>%
  #have to convert the datetime to MST, not UTC, if uploading a csv
  mutate(datetime = as.POSIXct(datetime, tz = 'MST'))

transub_wx_hourly_r <- read_csv('nsf/trans_unburned/trans_unburned_wx_hourly_r.csv') %>%
  #have to convert the datetime to MST, not UTC, if uploading a csv
  mutate(datetime = as.POSIXct(datetime, tz = 'MST'))

persb_wx_hourly_r <- read_csv('nsf/pers_burned/pers_burned_wx_hourly_r.csv') %>%
  #have to convert the datetime to MST, not UTC, if uploading a csv
  mutate(datetime = as.POSIXct(datetime, tz = 'MST'))

persb_wx_hourly_r <- read_csv('nsf/pers_burned/pers_burned_wx_hourly_r.csv') %>%
  #have to convert the datetime to MST, not UTC, if uploading a csv
  mutate(datetime = as.POSIXct(datetime, tz = 'MST'))

persub_wx_hourly_r <- read_csv('nsf/pers_unburned/pers_unburned_wx_hourly_r.csv') %>%
  #have to convert the datetime to MST, not UTC, if uploading a csv
  mutate(datetime = as.POSIXct(datetime, tz = 'MST'))
```

### Snow Camera Data

```{r}
#105E camera snow depths
dailymax105E_persb_snow <- read_csv('nsf/camera_snowdepths/2024_persb_lp_highmort_east_snowdepths.csv')

dailymax105E_transb_snow <- read_csv('nsf/camera_snowdepths/2024_105E_transb_snowdepths.csv')

dailymax105E_transub_snow <- read_csv('nsf/camera_snowdepths/2024_105E_transub_snowdepths.csv')
```

## Creating Snow depth-specific Dataframes

```{r}
#setting start and end dates for the winter 2023-24 season
## based on the snowdepth cameras 
start_datetime <- ymd_hms("2023-11-16 00:00:00", tz = "MST")

end_datetime <- ymd_hms("2024-06-05 00:00:00")
```

### Weather Station Snowdepth Data

```{r}
# creating a dataframe that is all of the weather station data including snow depths for the winter seasons 

#transitional 
full24_transb_snow_wxstation_data <- transb_wx_15min_r %>%
    #adding date and time columns
  mutate(
    date = as_date(datetime),
    time = format(datetime, "%H:%M:%S")) %>%
  #assigning a timezone then filtering to specific datetimestep for winter 2023-24
   mutate(datetime_mst = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime_mst >= as.POSIXct("2023-11-16 00:00:00", tz = "MST") & 
         datetime_mst <= as.POSIXct("2024-06-05 00:00:00", tz = "MST")) %>%
    select(-datetime) %>%
    rename(datetime = datetime_mst) %>%
    select(datetime, date, time, SnowDepth_m)

full24_transub_snow_wxstation_data <- transub_wx_hourly_r %>%
  #adding date and time columns
  mutate(
    date = as_date(datetime),
    time = format(datetime, "%H:%M:%S")) %>%
  #assigning a timezone then filtering to specific datetimestep for winter 2023-24
   mutate(datetime_mst = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime_mst >= as.POSIXct("2023-11-16 00:00:00", tz = "MST") & 
         datetime_mst <= as.POSIXct("2024-06-05 00:00:00", tz = "MST")) %>%
    select(-datetime) %>%
    rename(datetime = datetime_mst) %>%
    select(datetime, date, time, SnowDepth_m)

#persistent
full24_persb_snow_wxstation_data <- persb_wx_hourly_r %>%
  #adding date and time columns
  mutate(
    date = as_date(datetime),
    time = format(datetime, "%H:%M:%S")) %>%
  #assigning a timezone then filtering to specific datetimestep for winter 2023-24
   mutate(datetime_mst = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime_mst >= as.POSIXct("2023-11-16 00:00:00", tz = "MST") & 
         datetime_mst <= as.POSIXct("2024-06-05 00:00:00", tz = "MST")) %>%
    select(-datetime) %>%
    rename(datetime = datetime_mst) %>%
    select(datetime, date, time, SnowDepth_m)

full24_persub_snow_wxstation_data <- persub_wx_hourly_r %>%
  #adding date and time columns
  mutate(
    date = as_date(datetime),
    time = format(datetime, "%H:%M:%S")) %>%
  #assigning a timezone then filtering to specific datetimestep for winter 2023-24
   mutate(datetime_mst = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime_mst >= as.POSIXct("2023-11-16 00:00:00", tz = "MST") & 
         datetime_mst <= as.POSIXct("2024-06-05 00:00:00", tz = "MST")) %>%
    select(-datetime) %>%
    rename(datetime = datetime_mst) %>%
    select(datetime, date, time, SnowDepth_m)
```

```{r}
#daily maximum snow depth to compare to snow camera data

dailymax_transb_snow_wxstation <- full24_transb_snow_wxstation_data %>%
  group_by(date) %>%
  summarize(maxsnowdepth_m = max(SnowDepth_m)) %>%
  mutate(maxsnowdepth_cm = maxsnowdepth_m*100) %>%
  #adding in burn_status and zone columns
  mutate(burn_status = "burned", zone = "transitional")

dailymax_transub_snow_wxstation <- full24_transub_snow_wxstation_data %>%
  group_by(date) %>%
  summarize(maxsnowdepth_m = max(SnowDepth_m)) %>%
  mutate(maxsnowdepth_cm = maxsnowdepth_m*100) %>%
  mutate(burn_status = "unburned", zone = "transitional")

dailymax_persb_snow_wxstation <- full24_persb_snow_wxstation_data %>%
  group_by(date) %>%
  summarize(maxsnowdepth_m = max(SnowDepth_m)) %>%
  mutate(maxsnowdepth_cm = maxsnowdepth_m*100) %>%
  mutate(burn_status = "burned", zone = "persistent")

dailymax_persub_snow_wxstation <- full24_persub_snow_wxstation_data %>%
  group_by(date) %>%
  summarize(maxsnowdepth_m = max(SnowDepth_m)) %>%
  mutate(maxsnowdepth_cm = maxsnowdepth_m*100) %>%
  mutate(burn_status = "unburned", zone = "persistent")
```

### Snow Camera Snowdepth Data

\*\* don't have the following dataframe for persistent unburned because that camera did not work.

```{r}
#manipulating dataframes to match weather station dataframes, etc.

dailymax105E_persb_snow <- dailymax105E_persb_snow %>%
  #make date recognized as a date
  mutate(date = as.Date(date)) %>%
  mutate(maxsnowdepth_m = max_depth_cm/100) %>%
  #renameing mac depth column 
  rename(maxsnowdepth_cm = max_depth_cm) %>%
  #selecting only the rows I need
  select(date, zone, burn_status, mortality, conditions, maxsnowdepth_m, maxsnowdepth_cm)

dailymax105E_transb_snow <- dailymax105E_transb_snow %>%
  #make date recognized as a date
  mutate(date = as.Date(date)) %>%
  mutate(maxsnowdepth_m = max_depth_cm/100) %>%
  #renameing mac depth column 
  rename(maxsnowdepth_cm = max_depth_cm) %>%
  #selecting only the rows I need
  select(date, zone, burn_status, mortality, conditions, maxsnowdepth_m, maxsnowdepth_cm)

dailymax105E_transub_snow <- dailymax105E_transub_snow %>%
  #make date recognized as a date
  mutate(date = as.Date(date)) %>%
  mutate(maxsnowdepth_m = max_depth_cm/100) %>%
  #renameing mac depth column 
  rename(maxsnowdepth_cm = max_depth_cm) %>%
  #selecting only the rows I need
  select(date, zone, burn_status, mortality, conditions, maxsnowdepth_m, maxsnowdepth_cm)
```

### Combined Dataframes

```{r}
daily24_combined_snowdepths <- 
```

## Plotting Snowdepths 

```{r}
#colors for plots
#to display the colors
display.brewer.pal(n = 8, name = "Dark2")

#to get the hex number of the colors
brewer.pal(n = 8, name = "Dark2")
```

Plotting Persistent Weather Station & Snowstakes

```{r}
#persistent burned/unburned data weather station and snow camera data
dailypers_sd_plot <- ggplot() +
  geom_line(data = dailymax_persb_snow_wxstation, aes(x = date, y = maxsnowdepth_cm, color = "Pers Burned Wx Station")) + 
  geom_line(data = dailymax105E_persb_snow, aes(x = date, y = maxsnowdepth_cm, color = "Pers Burned Snowstake Camera")) +
  geom_line(data = dailymax_persub_snow_wxstation, aes(x= date, y = maxsnowdepth_cm, color =  "Pers Unburned Wx Station"), alpha = 0.7) +
  labs(
    #title = "Transitional Unburned",
    x = "Date",
    y = "Max Daily Snowdepth (cm)"
    ) +
  theme_bw() +
  scale_color_manual(values = c("Pers Burned Wx Station" = "#D95F02", "Pers Burned Snowstake Camera" = "#E6AB02", "Pers Unburned Wx Station" = "#66A61E"))

dailypers_sd_plot
```

Plotting Transitional Weather Station & Snowstakes

```{r}
dailytrans_sd_plot <- ggplot() +
  geom_line(data = dailymax_transb_snow_wxstation, aes(x = date, y = maxsnowdepth_cm, color = "Trans Burned Wx Station")) + 
  geom_line(data = dailymax105E_transb_snow, aes(x = date, y = maxsnowdepth_cm, color = "Trans Burned Snowstake Camera")) +
  geom_line(data = dailymax_transub_snow_wxstation, aes(x= date, y = maxsnowdepth_cm, color =  "Trans Unburned Wx Station"), alpha = 0.7) +
  geom_line(data = dailymax105E_transub_snow, aes(x= date, y = maxsnowdepth_cm, color =  "Trans Unburned Snowstake Camera"), alpha = 0.7) +
  labs(
    #title = "Transitional Unburned",
    x = "Date",
    y = "Max Daily Snowdepth (cm)"
    ) +
  theme_bw() +
  scale_color_manual(values = c("Trans Burned Wx Station" = "#D95F02", "Trans Burned Snowstake Camera" = "#E6AB02", "Trans Unburned Wx Station" = "#66A61E", "Trans Unburned Snowstake Camera"= "#7570B3"))

dailytrans_sd_plot
```

```{r}

## example plot to use code of!
burned_day_s_avg_plot <- ggplot(data = burned_day_s_avg_values) + 
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ zone + burn_status, scales = "free_y", dir = "h") +  # Facet by zone and phase
  labs(
    #title = "Transitional Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
    ) +
  theme_bw() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)

burned_day_s_avg_plot

## unburned
unburned_day_s_avg_plot <- ggplot(data = unburned_day_s_avg_values) + 
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ zone + burn_status, scales = "free_y", dir = "h") +  # Facet by zone and phase
  labs(
    #title = "Transitional Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
    ) +
  theme_bw() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)

unburned_day_s_avg_plot
```
